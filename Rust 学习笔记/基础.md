# 基础

## 语句与表达式

Rust 明确区分语句与表达式。语句是执行的操作，不返回值，表达式则必须返回值。

## 变量

Rust 变量默认不可变。与其它语言不同，将值赋给变量称为“绑定”。

### 变量类型

Rust 是静态类型语言，编译时必须知道所有类型。

除了常见的类型，有一种特殊的类型 `unit`，其唯一值是 `()`。表达式会隐式返回 `unit`。

## 流程控制

值得一提的是，Rust 能够通过标签指定 `break` 要跳出的循环层。另外，`if else` 也是表达式，返回为 `true` 的分支的值，所以各个分支必须返回相同的类型。

## 所有权

### 栈与堆

编译时能确定大小的变量分配在栈上，其它在堆上。栈速度更快。

### 变量作用域

每个变量有一个作用域，一旦离开作用域值就会失效，调用 `drop` 被回收。这种生命周期结束时释放资源的模式在 C++ 即 `RAII`。

### 字符串

Rust 内置的字符串类型只有 `str`，通常以 `&str` 出现，字符串字面量就是这个类型，而字面量显然是不可变的。标准库提供了 `String` 来作为可变字符串，它分配在堆上。

> `str` 是硬编码在二进制程序中的字符串，没有记录大小，只记录了内容，所以是动态大小的，无法在栈上创建实例。所以要使用 `str` 必须通过切片 `&str`，它指向某个内存中的字符串。

### 移动

当多个变量绑定同一块堆上的内存时，其中一个变量如果离开作用域，释放了空间，另一个变量离开作用域时再次释放就会造成 `double free`。为了解决这个问题，有两种方法：

1. 深拷贝。开辟新的内存，完全拷贝数据。
2. 移动。将所有权移交，原变量失效。

出于性能考虑，Rust 对堆上的数据默认进行 **移动**，而对栈上数据默认进行拷贝，因为拷贝代价低，没有理由使原来的变量失效。

函数传参与返回值时也会发生所有权移交。

### 引用与借用

如果函数调用后还需要使用传入的变量，就需要不断传入传出变量的所有权，太麻烦了。**引用** 是不用获取变量的所有权就能使用变量的方式。获取变量的引用称为 **借用**。

引用默认也是不可变的，可以用 `&mut s` 来使用可变变量，但有一些限制。

- **同一作用域不可以有两个同一个变量的可变引用**。这避免了数据竞争。
- **不可以同时有可变和不可变引用**。不可变引用的用户不会希望值在眼皮底下被修改。

**引用在任何时刻必须是有效的**。比如将函数内局部变量的引用返回出去是不允许的，因为引用指向的变量已经失效。

总结一下，引用的规则：

- 在任意给定时间，**要么** 只能有一个可变引用，**要么** 只能有多个不可变引用。
- 引用必须总是有效的。

### 切片（slice）

切片是对集合变量的部份引用。使用切片可以利用引用的特性，保证有效。字符串字面量就是切片 `&str`，它指向二进制程序的特定位置。

也有数组的 slice，如 `&[i32]`。

### 结构体

结构体与元组相似，但成员可以有名字，可以有 **关联函数**（associated functions）。

使用 `impl` 定义的函数称为关联函数，第一个参数为 `self` 的关联函数叫做 **方法**。关键字 `Self` 指代 `impl` 关键字后出现的类型。使用结构体名和 `::` 语法来调用关联函数。每个结构体可以有多个 `impl` 块。

> Rust 中使用 `::` 来调用某个类型下的内容

## 枚举

使用枚举来声明某个值是一个集合的一员。枚举可以将成员与值类型关联在一起。

`Option` 枚举很常用，直接包含在 prelude 中，表示一个值要么有值要么没值。这要求我们显式处理空值，避免错误地假设一个值不为空但实际上为空。

```rust
enum Option<T> {
    None,
    Some(T),
}
```

我们必须将 `Option<T>` 转换为 `T` 才能使用。可以使用 `match` 控制流来处理有值和无值两种情况。

### match

`match` 可以进行模式匹配，类似 `switch`。常用于枚举类型的模式匹配，且可以绑定匹配的模式的部份值。

`match` 的匹配 **必须** 是穷尽的。为此，Rust 提供了通配模式和 `_` 占位符。通配模式匹配值，并将值与 `other` 绑定，而 `_` 显式地丢弃了匹配的值。通配模式必须放在最后，因为后面的分支不会被匹配。

### if let

简化 `match`。可以认为是 `match` 的语法糖，只匹配一个模式，忽略其它所有模式。可以添加 `else` 对应 `match` 的 `_` 分支中的代码。
