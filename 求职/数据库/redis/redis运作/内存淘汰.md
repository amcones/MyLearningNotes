Redis使用maxmemory配置，在32位默认3G，64位不限制。当超过maxmemory时触发内存淘汰。

Redis支持两种淘汰策略，一种noeviction，不淘汰数据，写入操作失败。

另一种是多种淘汰策略，如LRU，LFU，RANDOM，TTL。每种可以根据key是否有过期时间决定是否淘汰。

## LRU

最近最久未使用，Redis使用近似LRU，维护全局链表成本太大，所以使用采样。

每个redisObject中有一个lru，存储它被访问时redis的时钟，当它被访问时更新。redis缓存了unix操作系统时钟，每毫秒更新一次，缓存的值对$2^{24}$取模。

每次随机取样n个key，默认5个，然后根据时间戳淘汰最旧的key，如果淘汰后内存还是不足就重复淘汰。

可以选择从allkey淘汰或者volatile从有过期时间的key随机采样。

### 淘汰池优化

Redis3.0使用一个大小为16的候选池，根据访问时间排序。

第一次随机选取的key都会放在池子，然后淘汰最久未访问的。然后每次随机选取的key只有活性比池子里活性最小的key还小的时候才会放入池子，装满了以后还要放入，就移出池子中活性最大的key。

池子里的数据会越来越接近真实的活性最低。

## LFU

最不频繁淘汰算法，淘汰使用频率最低的。

Redis4.0引入LFU。

LRU、LFU不会同时开启，所以LFU复用lru字段，将24bit拆解，高16bit存储ldt（上次访问时间戳），低8bit存储logc（访问次数）。因为少了8位，所以LFU时间精度1分钟。

如果上一次访问时间很久，访问次数就会衰减，访问后则会增加访问次数。

### 执行

1. 计算次数衰减，根据上次访问时间间隔计算应该减少几次
2. 一定概率增加访问次数，次数不足5次一定增加，否则一定概率，原来的次数越大，增加越困难。
3. 更新，当前时间更新到高16位，次数更新到低8位。